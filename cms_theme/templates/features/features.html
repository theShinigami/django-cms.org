{% load static cms_tags sekizai_tags frontend %}

<section class="features-section {% if instance.config.background_grid %} background-grid{% endif %} {{ instance.get_classes }}"{{ instance.get_attributes }}>
    <div class="container">
        {% for plugin in instance.child_plugin_instances %}
            {% if plugin.plugin_type == "TextPlugin" %}
                {% render_plugin plugin %}
            {% endif %}
            {% if plugin.plugin_type == "HeadingPlugin" %}
                {% render_plugin plugin %}
            {% endif %}
        {% endfor %}
        <div class="row gx-lg-6">
            {# Left column: Text content and accordion #}
            <div class="col-lg-6 {% if instance.config.mirror_layout %}order-lg-2{% endif %} features-content-left">
                {% for plugin in instance.child_plugin_instances %}
                    {% if plugin.plugin_type == "AccordionPlugin" %}
                        {# Custom accordion rendering without images #}
                        <div class="features-accordion mt-4 accordion-header-{{ instance.config.accordion_header_color|default:'default' }}">
                            <div class="accordion" id="accordion-{{ plugin.pk }}">
                                {% for accordion_item in plugin.child_plugin_instances %}
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="heading-{{ accordion_item.pk }}">
                                            <button class="accordion-button{% if not accordion_item.accordion_item_open %} collapsed{% endif %}"
                                                    type="button"
                                                    data-bs-toggle="collapse"
                                                    data-bs-target="#collapse-{{ accordion_item.pk }}"
                                                    aria-expanded="{% if accordion_item.accordion_item_open %}true{% else %}false{% endif %}"
                                                    aria-controls="collapse-{{ accordion_item.pk }}">
                                                {% inline_field accordion_item "accordion_item_header" %}
                                            </button>
                                        </h2>
                                        <div id="collapse-{{ accordion_item.pk }}"
                                             class="accordion-collapse collapse{% if accordion_item.accordion_item_open %} show{% endif %}"
                                             aria-labelledby="heading-{{ accordion_item.pk }}"
                                             data-bs-parent="#accordion-{{ plugin.pk }}">
                                            <div class="accordion-body">
                                                {# Render only non-image plugins #}
                                                {% for item_plugin in accordion_item.child_plugin_instances %}
                                                    {% if item_plugin.plugin_type != "ImagePlugin" %}
                                                        {% render_plugin item_plugin %}
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>

            {# Right column: Accordion images #}
            <div class="col-lg-6 {% if instance.config.mirror_layout %}order-lg-1{% endif %} features-content-right">
                <div class="features-images position-relative">
                    {% for plugin in instance.child_plugin_instances %}
                        {% if plugin.plugin_type == "AccordionPlugin" %}
                            {# Render accordion items' images on the right side #}
                            {% for accordion_item in plugin.child_plugin_instances %}
                                <div class="features-image{% if accordion_item.accordion_item_open %} active{% endif %}">
                                    {% for item_plugin in accordion_item.child_plugin_instances %}
                                        {% if item_plugin.plugin_type == "ImagePlugin" %}
                                            {% render_plugin item_plugin %}
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="d-flex">
            {% for plugin in instance.child_plugin_instances %}
                {% if plugin.plugin_type == "TextLinkPlugin" %}
                    {% render_plugin plugin %}
                {% endif %}
            {% endfor %}
        </div>
    </div>
</section>
